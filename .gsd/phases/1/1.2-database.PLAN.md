---
phase: 1
plan: 1.2
wave: 1
---

# Plan 1.2: Database & Auth Setup

## Objective

Set up the Supabase database schema, configure Row Level Security (RLS) policies, and implement Authentication in the Next.js app.

## Context

- .gsd/phases/1/RESEARCH.md (Schema & Policies)
- .gsd/SPEC.md (RBAC)

## Tasks

<task type="auto">
  <name>Initialize Supabase & Schema</name>
  <files>
    supabase/config.toml
    supabase/migrations/0000_initial_schema.sql
    supabase/seed.sql
  </files>
  <action>
    Initialize Supabase local environment.
    - Run `npx supabase init`.
    - Create `supabase/migrations/0000_initial_schema.sql` implementing the schema from RESEARCH.md (enums, tables, RLS policies).
    - Create `supabase/seed.sql` with initial data:
        - 1 DBKL Super Admin
        - 1 Property "PPR Pantai Ria"
        - 1 Flat Leader, 1 Finance Officer, 2 Residents for that property.
    - Apply migration: `npx supabase db reset`.
  </action>
  <verify>
    Run `npx supabase db diff` (should be empty).
    Query the database to ensure tables exist: `npx supabase db query "select count(*) from properties;"`
  </verify>
  <done>
    Database is running locally with schema and seed data applied.
  </done>
</task>

<task type="auto">
  <name>Implement Auth Integration</name>
  <files>
    lib/supabase/server.ts
    lib/supabase/client.ts
    lib/supabase/middleware.ts
    app/auth/login/page.tsx
    features/auth/login-form.tsx
  </files>
  <action>
    Integrate Supabase Auth with Next.js SSR.
    - Create Supabase client helpers (`createClient` for server/client).
    - Create Middleware for session management and protected routes protection.
    - Create Login Page (`/auth/login`) with Email/Password form.
    - Redirect to `/dashboard` on success.
  </action>
  <verify>
    Navigate to `/auth/login`. Enter credentials from seed.
    Verify redirection to `/dashboard`.
    Verify `sb-access-token` cookie is set.
  </verify>
  <done>
    User can log in and session is persisted.
  </done>
</task>

<task type="auto">
  <name>Implement Data Fetching Utilities</name>
  <files>
    lib/api/properties.ts
    lib/api/users.ts
  </files>
  <action>
    Create server-side data fetching functions to verify RLS.
    - `getProperties()`
    - `getCurrentUserProfile()`
    - Ensure these use `createClient` (server) and handle errors.
  </action>
  <verify>
    Call these functions in a temporary server component page.
    - Logged in as Admin -> See all properties.
    - Logged in as Resident -> See only own property (or none depending on policy).
  </verify>
  <done>
    Data access respects RLS policies.
  </done>
</task>

## Success Criteria

- [ ] Database schema matches RESEARCH.md.
- [ ] RLS policies enforce tenant isolation.
- [ ] Authentication flow (Login -> Dashboard) works.
- [ ] Middleware protects private routes.
